@section head{
	<script type="text/javascript" src="~/Static/Resources/_references.js"></script>
	<link rel="stylesheet" href="~/Static/Resources/site/Logic_PreviewBuy.css" />
}

<h1>@ViewBag.Title</h1>
<div class="hl"></div>
<div class="DesignInfo">
	<div class="imageShow">
		<div id="ShowEffect" class="group template">
			<script type="text/x-mustache">
			{{#items}}
			<div id="_{{GUID}}_backgroundImage" style="position: relative; background-image: url('/Static/SystemFiles/{{CurrentMaterialTypeID}}/{{CurrentMaterialID}}/{{CurrentColorCode}}/{{FileName}}'); width: {{Width}}px; height: {{Height}}px;">
				<div id="_{{GUID}}_uploadImage" class="uploadImage" style="background-image: url('/Static/UserFiles/{{UserID}}/{{DesignworkID}}/{{FileName}}'); width: {{getUploadWidth}}px; height: {{getUploadHeight}}px; left: {{Left}}px; top: {{Top}}px;"></div>
			</div>
			{{/items}}
			</script>
		</div>
	</div>
	<div id="ShowInfo" class="infoShow template">
		<script type="text/x-mustache">
		<div class="buy">
			{{^IsOver}}
			<a id="buy" class="button submitButton" href="javascript:void(0);" onclick="return false;">￥{{designwork.SellingPrice}} 购买</a>
			{{/IsOver}}
			{{#IsOver}}
			<span class="buyOver">活动已结束</span>
			{{/IsOver}}
		</div>
		<h2>关于</h2>
		<div id="Description">{{Description}}</div>
		</script>
	</div>
	<div class="ui-helper-clearfix"></div>
</div>
<div id="ShowMaterialInfo" class="MaterialInfo template">
	<script type="text/x-mustache">
	<div id="MaterialDescription">{{MaterialDescription}}</div>
	</script>
</div>
<div id="BuyList" class="template">
	<hr />
	<script type="text/x-mustache">
	<table>
		<tr>
			<td class="head">型号</td>
			<td class="head">数量</td>
		</tr>
		{{#size}}
		<tr>
			<td class="size">{{SizeName}}：</td>
			<td class="quantity"><input id="_{{GUID}}" value="0" class="Quantity" onkeypress="onlyNumber(this,event)" onblur="onlyNumber(this,event)"/></td>
		</tr>
		{{/size}}
	</table>
	<hr />
	合计：<span id="allQuantity">0</span>件、<span id="allPrice">0.00</span>元
	<span style="color: red;">注：两件起包邮哦！</span>
	</script>
</div>

@section scripts{
	<script type="text/javascript">
		var CanPost = true;

		var Data = @Html.Raw(ViewBag.Data);
		var DataMaterialpictures = { items: @Html.Raw(ViewBag.DataMaterialpictures) };
		var DataDesignwork = { designwork: @Html.Raw(ViewBag.DataDesignwork) };
		var DataSize = { size: @Html.Raw(ViewBag.DataSize) };

		$.extend(Data, DataMaterialpictures);
		$.extend(Data, DataDesignwork);
		$.extend(Data, DataSize);

		$(function ()
		{
			$.initTemplate();
			$("#ShowEffect").data("template_extend", {
				getUploadWidth: function ()
				{
					return this.UploadWidth * this.ShowScale;
				},
				getUploadHeight: function ()
				{
					return this.UploadHeight * this.ShowScale;
				}
			});

			$("#ShowEffect").render(Data);
			$("#ShowInfo").render(Data);
			$("#ShowMaterialInfo").render(Data);
			$("#BuyList").render(Data);

			$("#BuyList").dialog({
				autoOpen: false,
				modal: true,
				title: "选择尺寸和数量",
				buttons: [
				{
					text: "提交订单并付款",
					click: function ()
					{
						var sizes = "", quantities = "";
						$(":text", "#BuyList").each(function ()
						{
							var q = parseInt(this.value);
							if(q > 0)
							{
								sizes += this.id.substring(1) + ",";
								quantities += q + ",";
							}
						});
						var postdata = { guid: Data.DesignworkID, sizes: sizes, quantities: quantities };

						if(CanPost)
						{
							$.ajax({
								type: "post",
								cache: false,
								url: "@Url.Action("CreateOrder", "Logic")",
								data: postdata,
								success: function (data)
								{
									var dataobj = JSON.parse(data);
									if(dataobj.code == -99)
									{
										$("#loginDialog").dialog("open");
									}
									else if (dataobj.code > 0)
									{
										//转到选择地址和支付页面
										location.href = "@Url.Action("ConfirmOrder", "Logic")" + "?guid=" + dataobj.msg;
									}
									else
									{
										$("#MessageDialog_Message").html(dataobj.msg);
										$("#MessageDialog").dialog("option", { title: "错误提示", width: 350 });
										$("#MessageDialog").dialog("open");
									}
									CanPost = true;
								},
								error: function (XMLHttpRequest, textStatus, errorThrown)
								{
									CanPost = true;
									$("#MessageDialog_Message").html("网络错误，请重试！");
									$("#MessageDialog").dialog("option", { title: "错误提示", width: 200 });
									$("#MessageDialog").dialog("open");
								}
							});
							CanPost = false;
						}
					}
				},
				{
					text: "取消",
					click: function ()
					{
						$(this).dialog("close");
						//$(":text", "#BuyList").each(function ()
						//{
						//	this.value = "0";
						//});
						//$("#allQuantity").text("0");
						//$("#allPrice").text("0.00");
					}
				}]
			});

			$("#buy").click(function ()
			{
				//if($("#btnLogin").length != 0)
				//	$("#loginDialog").dialog("open");
				//else
					$("#BuyList").dialog("open");
			});

			$(":text", "#BuyList").change(function ()
			{
				var allQuantity = 0;
				if($(this).val().length == 0)
					$(this).val("0");
				$(":text", "#BuyList").each(function ()
				{
					allQuantity += parseInt(this.value);
				});
				$("#allQuantity").text(allQuantity);
				$("#allPrice").text(RetainDigits(allQuantity * DataDesignwork.designwork.SellingPrice, 2));
			});
		});
	</script>
}